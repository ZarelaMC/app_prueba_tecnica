name: Build
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run tests and generate coverage
        run: npx jest --coverage

      - name: Clean SonarQube Cache
        run: rm -rf .scannerwork

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: "ZarelaMC_app_prueba_tecnica"
          SONAR_ORGANIZATION: "zarelamc"

      - name: Obtener resultados del an√°lisis
        id: sonar_check
        run: |
          sudo apt-get install -y jq
          SONAR_PROJECT_KEY="ZarelaMC_app_prueba_tecnica"
          STATUS=$(curl -s "https://sonarcloud.io/api/qualitygates/project_status?projectKey=$SONAR_PROJECT_KEY" \
          -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" | jq -r '.projectStatus.status')
          echo "SonarCloud Status: $STATUS"
          echo "status=$STATUS" >> $GITHUB_ENV

      - name: Validar resultados de SonarCloud
        run: |
          if [[ "$status" != "OK" ]]; then
            echo "‚ùå C√≥digo no aprobado por SonarCloud. Revisi√≥n requerida."
            exit 1
          else
            echo "‚úÖ C√≥digo aprobado por SonarCloud. Continuando con el despliegue..."
          fi

      - name: Mostrar mensaje final
        run: |
          SONAR_PROJECT_KEY="ZarelaMC_app_prueba_tecnica"
          echo "üéØ An√°lisis de SonarCloud finalizado."
          if [[ "$status" != "OK" ]]; then
            echo "‚ùå Fallos detectados en el c√≥digo. Revisa SonarCloud: https://sonarcloud.io/dashboard?id=$SONAR_PROJECT_KEY"
            exit 1
          else
            echo "‚úÖ C√≥digo limpio. Puedes proceder con el despliegue."
          fi
